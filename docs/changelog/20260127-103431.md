# 视频分析功能

## 任务描述
- 实现视频内容分析功能
- 支持用户选择（全部或单个用户）
- 显示待分析视频数量
- 添加分析相关系统设置
- 使用 Grok Vision API 进行内容分析

## 待办清单
- [x] 数据库添加分析相关字段和设置
- [x] 创建视频分析服务
- [x] 系统设置页面添加分析配置
- [x] 创建分析页面

## 修改内容

### 数据库变更 (src/main/database/index.ts)
1. 新增分析结果字段迁移：
   - `analysis_tags` - 标签数组（JSON 字符串）
   - `analysis_category` - 分类
   - `analysis_summary` - 摘要
   - `analysis_scene` - 场景
   - `analysis_sexy_level` - 擦边等级 (1-10)
   - `analyzed_at` - 分析时间戳
2. 新增分析相关默认设置：
   - `analysis_concurrency` - 并发数量（默认 2）
   - `analysis_rpm` - 每分钟请求数（默认 10）
   - `analysis_model` - 模型名称（默认 grok-2-vision-latest）
   - `analysis_slices` - 视频切片数（默认 4）
   - `analysis_prompt` - 分析提示词
3. 新增 `AnalysisResult` 接口
4. 新增分析函数：
   - `getUnanalyzedPostsCount(secUid?)` - 获取待分析数量
   - `getUnanalyzedPostsCountByUser()` - 按用户统计待分析数量
   - `getUnanalyzedPosts(secUid?, limit?)` - 获取待分析作品列表
   - `updatePostAnalysis(id, result)` - 更新分析结果

### 分析服务 (src/main/services/analyzer.ts) - 新增
1. `AnalysisProgress` 接口 - 分析进度状态
2. `RateLimiter` 类 - API 速率限制器
3. `extractVideoFrames(videoPath, sliceCount)` - 使用 ffmpeg 提取视频帧
4. `loadImageAsBase64(imagePath)` - 加载图片为 Base64
5. `callVisionAPI(images, prompt, ...)` - 调用 Grok Vision API
6. `analyzePost(post, ...)` - 分析单个作品
7. `runWithConcurrency(tasks, concurrency)` - 并发控制执行
8. `startAnalysis(secUid?)` - 启动分析任务
9. `stopAnalysis()` - 停止分析任务
10. `isAnalysisRunning()` - 检查运行状态

### IPC 通信 (src/main/index.ts)
1. 新增 `analysis:start` 处理器
2. 新增 `analysis:stop` 处理器
3. 新增 `analysis:isRunning` 处理器
4. 新增 `analysis:getUnanalyzedCount` 处理器
5. 新增 `analysis:getUnanalyzedCountByUser` 处理器

### Preload API (src/preload/index.ts, index.d.ts)
1. `DbPost` 接口新增分析结果字段
2. 新增 `AnalysisProgress` 接口
3. 新增 `UnanalyzedUserCount` 接口
4. 新增 `AnalysisAPI` 接口及实现

### 系统设置页面 (src/renderer/src/pages/settings/SystemPage.tsx)
新增分析设置卡片：
- 并发数量输入框
- 每分钟请求数 (RPM) 输入框
- 模型名称输入框
- 视频切片数输入框
- 分析提示词文本框

### 分析页面 (src/renderer/src/pages/settings/AnalysisPage.tsx) - 重写
1. 用户选择下拉框（支持全部或单个用户）
2. 待分析视频数量显示
3. 开始/停止分析按钮
4. 分析进度条显示
5. 按用户统计待分析数量列表
6. 分析统计卡片（待分析、已分析、待分析用户数）

## 功能说明

### 分析流程
1. 选择要分析的用户（全部或单个）
2. 点击"开始分析"
3. 系统自动判断作品类型：
   - **视频**：使用 ffmpeg 按切片数均匀截取帧图
   - **图集**：按顺序加载图片（最多 10 张）
4. 将图片发送到 Grok Vision API 进行分析
5. 解析返回的 JSON，保存标签、分类、摘要等信息

### 分析配置
- **并发数量**：同时分析的作品数量
- **每分钟请求数**：API 速率限制，避免触发限流
- **模型名称**：使用的视觉模型（默认 grok-2-vision-latest）
- **视频切片数**：从视频中截取的帧数
- **分析提示词**：发送给 AI 的分析指令

### 分析结果
- **tags**：标签数组（如：黑丝、高跟鞋、舞蹈等）
- **category**：分类（舞蹈/穿搭展示/Cosplay/写真/日常/教程）
- **summary**：一句话描述
- **scene**：场景（卧室/客厅/户外/舞房/其他）
- **sexy_level**：擦边等级 1-10

## 依赖
- `@ffmpeg-installer/ffmpeg` - 内置 ffmpeg 二进制文件
- `@ffprobe-installer/ffprobe` - 内置 ffprobe 二进制文件
- `fluent-ffmpeg` - ffmpeg API 封装库

## 打包配置
在 `electron-builder.yml` 中配置 `asarUnpack` 将 ffmpeg 二进制文件解包：
```yaml
asarUnpack:
  - resources/**
  - node_modules/@ffmpeg-installer/**
  - node_modules/@ffprobe-installer/**
```

这样打包后的应用会自动包含对应平台的 ffmpeg，无需用户额外安装。

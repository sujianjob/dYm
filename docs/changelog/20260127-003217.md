# 变更日志 - 2026-01-27 00:32:17

## 任务描述
1. 下载功能添加限速（每10个作品休息3秒）
2. 首页接入真实视频数据

## 执行结果

### 1. 下载限速
**文件**: `src/main/services/downloader.ts`
- 每下载 10 个作品后暂停 3 秒
- 显示休息提示信息
- 移除 p-limit 依赖，改用自实现的并发控制函数

### 2. 首页真实数据

**数据库** (`src/main/database/index.ts`)
- 新增 `getAllPosts(page, pageSize)` 函数，支持分页获取所有作品

**IPC** (`src/main/index.ts`)
- 新增 `post:getAll` 处理器
- 注册 `local://` 自定义协议用于加载本地文件

**Preload** (`src/preload/index.ts`, `src/preload/index.d.ts`)
- 新增 `window.api.post.getAll()` API
- 新增 `DbPost` 和 `PostAPI` 类型定义

**首页** (`src/renderer/src/pages/HomePage.tsx`)
- 从数据库加载已下载的视频列表
- 使用 `local://` 协议显示本地封面图片
- 视频卡片网格布局（响应式 2-5 列）
- 显示视频标题、作者、发布日期
- 鼠标悬停显示播放图标
- 空状态引导用户前往设置

### 自定义协议
```typescript
// 注册 local:// 协议，用于在渲染进程中加载本地文件
protocol.registerSchemesAsPrivileged([
  { scheme: 'local', privileges: { bypassCSP: true, stream: true, supportFetchAPI: true } }
])

protocol.handle('local', (request) => {
  const filePath = decodeURIComponent(request.url.replace('local://', ''))
  return net.fetch(`file://${filePath}`)
})
```

### 3. 封面路径修复

**问题**: dy-downloader 生成的文件夹名过于复杂
- 旧格式: `2023-11-07 15-40-38_人与人之间的滤镜无非是一双偏爱的眼睛_7298498173142715683`
- 新格式: `7298498173142715683` (仅 aweme_id)

**下载器修改** (`src/main/services/downloader.ts`):
- `naming` 从 `{create}_{desc}_{aweme_id}` 改为 `{aweme_id}`
- `formatFolderName` 简化为直接返回 aweme_id

**封面查找** (`src/main/index.ts`):
- 新增 `findCoverFile(secUid, folderName)` 函数
- 直接用 aweme_id 匹配文件夹
- 兼容旧格式：扫描包含 aweme_id 的文件夹
- 新增 `post:getCoverPath` IPC handler

**首页更新** (`src/renderer/src/pages/HomePage.tsx`):
- 异步加载封面路径
- 使用 `coverPaths` state 缓存路径映射

### 4. 作品查看功能

**作品类型判断**:
- 视频: `aweme_type` 为 0, 4, 55, 61, 109, 201 → 显示 `.mp4`
- 图集: `aweme_type` 为 68 → 显示 `.webp` 图片

**新增 IPC** (`src/main/index.ts`):
- `post:getMediaFiles(secUid, folderName, awemeType)` 返回媒体文件列表
- 返回 `{ type: 'video' | 'images', video?, images?, cover? }`

**MediaViewer 组件** (`src/renderer/src/components/MediaViewer.tsx`):
- 视频播放器：支持自动播放、播放控制
- 图集浏览器：左右切换、键盘导航
- 显示作品标题、作者信息

**首页卡片**:
- 显示作品类型标签（视频/图集）
- 点击打开 MediaViewer 查看
- 不同类型显示不同图标

### 5. 排序与筛选

**排序调整**:
- 改为按 `create_time` 倒序（新发布的在前）
- 原先按 `downloaded_at` 排序

**作者筛选** (`src/main/database/index.ts`):
- 使用 `sec_uid` 筛选（稳定不变）
- 返回作者列表 `{ sec_uid, nickname }`
- 下拉框显示昵称，实际按 sec_uid 查询

**首页** (`src/renderer/src/pages/HomePage.tsx`):
- Header 添加作者下拉筛选框
- 支持清空筛选（显示全部）
